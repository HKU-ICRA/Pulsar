import os
import numpy as np

from rmleague.player import Player
from rmleague.agent import Agent


class LeagueExploiter(Player):

  def __init__(self, agent, payoff, player_file, name):
    #self.agent = Agent(agent.get_weights())
    self.agent = agent
    self._initial_weights = agent.get_weights()
    self._payoff = payoff
    self.player_file = player_file
    self.name = name
    self._checkpoint_step = 0

  def get_match(self):
    historical = [
        player for player in self._payoff.players
        if isinstance(player, Historical)
    ]
    win_rates = self._payoff[self, historical]
    return np.random.choice(
        historical, p=pfsp(win_rates, weighting="linear_capped")), True

  def checkpoint(self):
    if np.random.random() < 0.25:
      self.agent.set_weights(self._initial_weights)
    self._checkpoint_step = self.agent.get_steps()
    return self._create_checkpoint()

  def ready_to_checkpoint(self):
    steps_passed = self._agent.get_steps() - self._checkpoint_step
    if steps_passed < 2e9:
      return False
    historical = [
        player for player in self._payoff.players
        if isinstance(player, Historical)
    ]
    win_rates = self._payoff[self, historical]
    return win_rates.min() > 0.7 or steps_passed > 4e9
  
  def save(self):
    with open(self.player_file, 'wb') as f:
      pickle.dump(self._checkpoint_step, f)
  
  def load(self):
    if os.path.isfile(self.player_file):
      with open(self.player_file, 'rb') as f:
        self._checkpoint_step = pickle.load(f)